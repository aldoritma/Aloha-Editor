// Generated by CoffeeScript 1.5.0
(function() {

  define(['aloha', 'aloha/plugin', 'jquery', 'aloha/ephemera', 'ui/ui', 'ui/button'], function(Aloha, Plugin, jQuery, Ephemera, UI, Button) {
    var NEW_NOTE_TEMPLATE, bindNoteEventsTo, enable, mostSeniorEditableOf;
    NEW_NOTE_TEMPLATE = '<div class="note-container">\n    <div class="note-controlls">\n       <a href="" class="note-delete"><i class="icon-remove"></i></a> \n       <a href=""><i class="icon-cog"></i></a> \n    </div> \n    <div class="note">\n        <div class="title"></div>\n        <div class="body">Replace this with the body of the note</div>\n    </div>\n</div>';
    UI.adopt('insertNote', Button, {
      click: function(a, b, c) {
        var $newNote, range;
        range = Aloha.Selection.getRangeObject();
        $newNote = jQuery(NEW_NOTE_TEMPLATE);
        $newNote.addClass('aloha-new-note');
        GENTICS.Utils.Dom.insertIntoDOM($newNote, range, Aloha.activeEditable.obj);
        $newNote = Aloha.jQuery('.aloha-new-note');
        $newNote.removeClass('aloha-new-note');
        return enable($newNote);
      }
    });
    mostSeniorEditableOf = function($node) {
      return $node.parents('.aloha-editable').last();
    };
    bindNoteEventsTo = function($node) {
      if ($node.data('noteEventsInitialized')) {
        return;
      }
      console.log('binding note events');
      $node.data('noteEventsInitialized', true);
      $node.on('mouseenter', '.aloha-block-draghandle', function() {
        return $(this).parents('.note-container').addClass('drag-active');
      }).on('mouseleave', '.aloha-block-draghandle', function() {
        if (!$(this).data('dragging')) {
          return $(this).parents('.note-container').removeClass('drag-active');
        }
      }).on('mousedown', '.aloha-block-draghandle', function() {
        return $(this).data('dragging', true);
      }).on('mouseup', '.aloha-block-draghandle', function() {
        return $(this).data('dragging', false);
      });
      $node.on('mouseover', '.note-container', function() {
        if (!$(this).find('.note-container.active').length) {
          $(this).addClass('active');
        }
        return $(this).parents('.note-container').removeClass('active');
      }).on('mouseleave', '.note-container', function() {
        return $(this).removeClass('active');
      });
      return $node.on('click', '.note-container .note-delete', function(e) {
        var $note;
        e.preventDefault();
        $note = $(this).parents('.note-container').first();
        return $note.slideUp('slow', function() {
          return $note.remove();
        });
      });
    };
    enable = function($noteContainer) {
      var $body, $note, $title;
      $note = $noteContainer.children('.note');
      $title = $note.children('.title');
      if (!$title.is('.title')) {
        $title = jQuery('<h1 class="title"></h1>').prependTo($note);
      }
      $body = $note.find('.body');
      if (!$body[0]) {
        $body = jQuery('<div class="body"></div>');
        $note.children().not($title).appendTo($body);
      }
      $body.appendTo($note);
      $title.aloha();
      $body.aloha();
      $noteContainer.alohaBlock();
      return bindNoteEventsTo(mostSeniorEditableOf($noteContainer));
    };
    return Aloha.bind('aloha-editable-activated', function(evt, props) {
      return props.editable.obj.find('.note').each(function(i, note) {
        return enable(jQuery(note));
      });
    });
  });

}).call(this);
