// Generated by CoffeeScript 1.3.3
(function() {

  define(['aloha', 'jquery', 'popover', 'ui/ui', 'aloha/console'], function(Aloha, jQuery, Popover, UI, console) {
    var DIALOG_HTML, populator, selector, showModalDialog;
    DIALOG_HTML = '<form class="modal" id="linkModal" tabindex="-1" role="dialog" aria-labelledby="linkModalLabel" aria-hidden="true">\n  <div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>\n    <h3 id="linkModalLabel">Edit Concord Simulation (experimental)</h3>\n  </div>\n  <div class="modal-body">\n    <h4>Concord iframe URL</h4>\n    <div>\n      <select id="experiment-url">\n        <option>--- Concord Examples ---</option>\n        <option value="http://concord-consortium.github.com/lab/examples/interactives/embeddable.html#interactives/basic-examples/pulling-uncharged-atoms.json">pulling-uncharged-atoms</option>\n        <option value="http://concord-consortium.github.com/lab/examples/interactives/embeddable.html#interactives/sam/intermolecular-attractions-page-1.json">intermolecular-attractions-page-1</option>\n        <option value="http://concord-consortium.github.com/lab/examples/interactives/embeddable.html#interactives/sam/intermolecular-attractions-page-2.json">intermolecular-attractions-page-2</option>\n        <option value="http://concord-consortium.github.com/lab/examples/interactives/embeddable.html#interactives/sam/intermolecular-attractions-page-3-1.json">intermolecular-attractions-page-3-1</option>\n        <option value="http://concord-consortium.github.com/lab/examples/interactives/embeddable.html#interactives/sam/intermolecular-attractions-page-3-2.json">intermolecular-attractions-page-3-2</option>\n        <option value="http://concord-consortium.github.com/lab/examples/interactives/embeddable.html#interactives/basic-examples/boiling-point-with-energy-graph.json">boiling-point-with-energy-graph</option>\n        <option>--- PhET Examples ---</option>\n        <option value="http://www.colorado.edu/physics/phet/dev/faraday-html/00.00.01/faraday.html">PhET: Faraday</option>\n        <option value="http://www.colorado.edu/physics/phet/dev/energy-skate-park-html/00.00.13/">PhET: Skate Park\n      </select>\n    </div>\n    <div>\n      <label>Width: </label>\n      <input name="width" type="number" placeholder="Width" required/>\n      <label>Height: </label>\n      <input name="height" type="number" placeholder="Height" required/>\n    </div>\n  </div>\n  <div class="modal-footer">\n    <button class="btn btn-primary link-save">Submit</button>\n    <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>\n  </div>\n</form>';
    showModalDialog = function($el) {
      var $height, $save, $url, $width, dialog, root,
        _this = this;
      root = Aloha.activeEditable.obj;
      dialog = jQuery(DIALOG_HTML);
      $save = dialog.find('.link-save');
      $url = dialog.find('#experiment-url');
      $width = dialog.find('*[name=width]');
      $height = dialog.find('*[name=height]');
      $url.val($el.attr('src'));
      $url.focus();
      $width.val($el.attr('width'));
      $height.val($el.attr('height'));
      $save.on('click', function(evt) {
        evt.preventDefault();
        return dialog.trigger('submit');
      });
      dialog.on('submit', function(evt) {
        evt.preventDefault();
        $el.attr('src', $url.val());
        return dialog.modal('hide');
      });
      dialog.modal('show');
      dialog.on('hidden', function() {
        return dialog.remove();
      });
      return dialog;
    };
    selector = 'iframe';
    populator = function($el) {
      var $bubble, change, editable, remove,
        _this = this;
      editable = Aloha.activeEditable;
      $bubble = jQuery('<div class="link-popover"></div>');
      change = jQuery('<button class="btn">Change...</div>').appendTo($bubble);
      change.on('click', function() {
        var dialog;
        Aloha.activeEditable = editable;
        return dialog = showModalDialog($el);
      });
      remove = jQuery('<button class="btn btn-danger">Remove</div>').appendTo($bubble);
      remove.on('click', function() {
        $el.remove();
        return jQuery(_this).popover('hide');
      });
      return $bubble.contents();
    };
    UI.adopt('insertSimulation', null, {
      click: function() {
        var dialog, newFrame,
          _this = this;
        newFrame = jQuery('<iframe frameborder="1" height="400" scrolling="no" width="800"></iframe>');
        dialog = showModalDialog(newFrame);
        return dialog.on('hidden', function() {
          var range;
          if (!newFrame.attr('src')) {
            return;
          }
          range = Aloha.Selection.getRangeObject();
          if (range.isCollapsed()) {
            GENTICS.Utils.Dom.extendToWord(range);
          }
          if (range.isCollapsed()) {
            GENTICS.Utils.Dom.insertIntoDOM(newFrame, range, Aloha.activeEditable.obj);
            range.startContainer = range.endContainer = newFrame.contents()[0];
            range.startOffset = 0;
            range.endOffset = newFrame.text().length;
          } else {
            GENTICS.Utils.Dom.addMarkup(range, newFrame, false);
          }
          newFrame = Aloha.activeEditable.obj.find('.aloha-new-link');
          return newFrame.removeClass('aloha-new-link');
        });
      }
    });
    return Popover.register({
      hover: true,
      selector: selector,
      populator: populator
    });
  });

}).call(this);
